# 交易指标计算模块 (metrics.ts)

本模块是交易应用核心计算部分，负责统一处理13项关键指标，提供一致、可靠的数据给所有UI组件使用。

## 指标说明

系统计算的13项指标如下：

- **M1**: 账户总成本 - 当前所有持仓的成本总和
- **M2**: 当前市值 - 当前所有持仓的市场价值
- **M3**: 当前浮动盈亏 - 目前未实现的盈亏（M2-M1）
- **M4**: 当日已实现盈亏 - 今日交易中历史持仓部分的盈亏
- **M5**: 日内交易盈亏 - 今日内建仓并卖出部分的盈亏
- **M6**: 当日浮动盈亏 - 当前浮动盈亏加上历史持仓的已实现盈亏（M3+M4）
- **M7**: 当日交易次数 - 今日交易的总次数
- **M8**: 累计交易次数 - 历史及今日交易的总次数
- **M9**: 历史已实现盈亏 - 所有已实现的盈亏总和（含M4和M5）
- **M10**: 胜率 - 盈利交易次数占总交易次数的比例
- **M11**: WTD (Week-To-Date) - 本周至今的盈亏
- **M12**: MTD (Month-To-Date) - 本月至今的盈亏
- **M13**: YTD (Year-To-Date) - 本年至今的盈亏

## 黄金案例测试集

我们提供了四个"黄金案例"作为标准测试集，这些案例覆盖了不同的交易场景，确保指标计算的准确性和稳定性：

### 案例A: 原始综合场景（TSLA + GOOGL）

混合多个股票、历史持仓、当日交易，覆盖多头和空头。

- TSLA: 历史持仓100@90，当日买入50@95后卖出100@105
- GOOGL: 当日做空40@1500，回补20@1480

### 案例B: 纯多头FIFO出清

测试历史多批次买入后的大量卖出场景。

- XYZ: 历史持仓200@50+100@55，当日卖出250@60

### 案例C: 纯空头FIFO回补

测试历史空头部分回补的场景。

- ABC: 历史空头持仓300@120，当日回补180@110

### 案例D: 同日部分成交与再建仓

测试完全日内交易循环：买入、部分卖出、再买入。

- DEF: 当日买入100@20，卖出30@22，再买入40@21

## 计算规则要点

1. **FIFO成本匹配**: 使用先进先出法匹配成本
2. **行为匹配**: 区分当日交易和历史交易
3. **持仓更新**: 平仓时按FIFO顺序弹出最早批次
4. **实现盈亏归属**:
   - M4: 历史持仓部分的已实现盈亏
   - M5: 日内交易的已实现盈亏
5. **浮盈计算**: 仅计算剩余持仓的浮动盈亏
6. **周期统计**: WTD/MTD/YTD根据日期范围计算

## 测试与验证

使用以下命令运行黄金案例测试：

```bash
npm test -- apps/web/app/lib/metrics.golden.test.ts
```

这些测试确保我们的指标计算逻辑准确可靠，任何对算法的修改都应先通过这些测试。

## 注意事项

1. 所有指标计算集中在`calcMetrics()`函数中，确保一致性
2. 浮动盈亏计算使用最新价格数据
3. UI组件应从全局状态获取指标，而非自行计算
4. 添加新指标时，请同时更新测试用例
